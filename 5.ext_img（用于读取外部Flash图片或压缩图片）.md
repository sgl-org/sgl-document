# External Image æŽ§ä»¶åº”ç”¨æŒ‡å—

## 1. ç®€ä»‹

`ExtImg`ï¼ˆå¤–éƒ¨å›¾ç‰‡æŽ§ä»¶ï¼‰æ˜¯ SGL æä¾›çš„ä¸€ç§**é«˜æ•ˆåŠ è½½å¤–éƒ¨å­˜å‚¨å›¾åƒ**çš„ä¸“ç”¨æŽ§ä»¶ï¼Œç‰¹åˆ«é€‚ç”¨äºŽèµ„æºå—é™çš„åµŒå…¥å¼ç³»ç»Ÿã€‚å®ƒæ”¯æŒï¼š

- ä»Ž **å¤–éƒ¨ Flashã€SD å¡ã€ç½‘ç»œç¼“å†²åŒºç­‰éž RAM åŒºåŸŸ** è¯»å–å›¾åƒæ•°æ®
- æ”¯æŒ **åŽŸå§‹æ ¼å¼ï¼ˆRGB565/RGB888 ç­‰ï¼‰** å’Œ **RLE åŽ‹ç¼©æ ¼å¼**
- å¯è®¾ç½® **é€æ˜Žåº¦ï¼ˆAlphaï¼‰**
- é€šè¿‡è‡ªå®šä¹‰è¯»å–å‡½æ•°ï¼ˆ`read_ops`ï¼‰å®žçŽ°çµæ´»çš„æ•°æ®è®¿é—®

> âœ… å…¸åž‹åº”ç”¨åœºæ™¯ï¼šå›¾æ ‡æ˜¾ç¤ºã€èƒŒæ™¯å›¾ã€åŠ¨æ€åŠ è½½èµ„æºåŒ…ä¸­çš„å›¾ç‰‡ç­‰ã€‚

---

## 2. æ ¸å¿ƒæ¦‚å¿µ

### 2.1 å›¾åƒæè¿°ç»“æž„ï¼š`sgl_pixmap_t`

æ‰€æœ‰å›¾åƒå¿…é¡»å…ˆå®šä¹‰ä¸º `sgl_pixmap_t` ç»“æž„ä½“ï¼š

```c
typedef struct sgl_pixmap {
    uint32_t width  : W;   // å›¾åƒå®½åº¦ï¼ˆåƒç´ ï¼‰
    uint32_t height : H;   // å›¾åƒé«˜åº¦ï¼ˆåƒç´ ï¼‰
    uint32_t format : SGL_PIXMAP_FMT_XXXX;    // å›¾åƒæ ¼å¼ï¼ˆè§ä¸‹è¡¨ï¼‰
    const uint8_t *bitmap;  // å›¾åƒæ•°æ®æŒ‡é’ˆï¼ˆå¯æŒ‡å‘ Flash åœ°å€ï¼‰
} sgl_pixmap_t;
```

#### æ”¯æŒçš„å›¾åƒæ ¼å¼ï¼ˆ`format` å­—æ®µï¼‰

| å®å®šä¹‰                         | è¯´æ˜Ž                 |
| --------------------------- | ------------------ |
| `SGL_PIXMAP_FMT_RGB332`     | 8-bit RGB (3-3-2)  |
| `SGL_PIXMAP_FMT_RGB565`     | 16-bit RGB (5-6-5) |
| `SGL_PIXMAP_FMT_RGB888`     | 24-bit RGB (8-8-8) |
| `SGL_PIXMAP_FMT_RLE_RGB332` | RLE åŽ‹ç¼©çš„ RGB332     |
| `SGL_PIXMAP_FMT_RLE_RGB565` | RLE åŽ‹ç¼©çš„ RGB565     |
| `SGL_PIXMAP_FMT_RLE_RGB888` | RLE åŽ‹ç¼©çš„ RGB888     |

> âš ï¸ æ³¨æ„ï¼šå¿…é¡»æŒ‡å®šå…·ä½“æ ¼å¼ã€‚
>åŒæ—¶éœ€è¦æ³¨æ„çš„æ˜¯ä½ åœ¨è®¾ç½®å›¾åƒæ ¼å¼çš„æ—¶å€™å¿…é¡»å’Œä½ åœ¨sgl_config.h æ–‡ä»¶ä¸­å®šä¹‰çš„CONFIG_SGL_PANEL_PIXEL_DEPTHä¸€è‡´ã€‚å…¸åž‹é”™è¯¯ï¼š
>~~<font color="#c00000"><u><span style="background:#d3f8b6">#define Â CONFIG_SGL_PANEL_PIXEL_DEPTH Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 16</span></u></font>~~
>
>~~<font color="#c00000"><u><span style="background:#fff88f">uint32_t format : SGL_PIXMAP_FMT_RGB888;</span></u></font>~~
>å®šä¹‰16bit å®žé™…å´ç”¨888çš„ã€‚

---

## 3. ExtImg æŽ§ä»¶æŽ¥å£

### 3.1 åˆ›å»ºæŽ§ä»¶

```c
sgl_obj_t* sgl_ext_img_create(sgl_obj_t* parent);
```
- **`parent`**ï¼šçˆ¶å¯¹è±¡ï¼ˆå¦‚ `Page` æˆ– `Rect`ï¼‰
- è¿”å›žå€¼ï¼šæŒ‡å‘æ–°åˆ›å»ºçš„ `ExtImg` å¯¹è±¡çš„æŒ‡é’ˆ

### 3.2 è®¾ç½®å›¾åƒæ•°æ®

```c
void sgl_ext_img_set_pixmap(sgl_obj_t *obj, const sgl_pixmap_t *pixmap);
```
- **`obj`**ï¼šç”± `sgl_ext_img_create()` è¿”å›žçš„å¯¹è±¡
- **`pixmap`**ï¼šæŒ‡å‘å·²åˆå§‹åŒ–çš„ `sgl_pixmap_t` ç»“æž„ä½“

### 3.3 è®¾ç½®è‡ªå®šä¹‰è¯»å–å‡½æ•°ï¼ˆå…³é”®ï¼ï¼‰

```c
void sgl_ext_img_set_read_ops(sgl_obj_t *obj, 
    void (*read)(const uint8_t *addr, uint8_t *out, uint32_t len_bytes));
```
- **`read`**ï¼šç”¨æˆ·å®žçŽ°çš„è¯»å–å›žè°ƒå‡½æ•°ï¼Œç”¨äºŽä»Žå¤–éƒ¨å­˜å‚¨ï¼ˆå¦‚ Flashï¼‰æ‹·è´æ•°æ®åˆ° RAM
  - `addr`ï¼šæºåœ°å€ï¼ˆå³ `pixmap->bitmap + offset`ï¼‰
  - `out`ï¼šç›®æ ‡ç¼“å†²åŒºï¼ˆSGL å†…éƒ¨æä¾›ï¼‰
  - `len_bytes`ï¼šéœ€è¦è¯»å–çš„å­—èŠ‚æ•°

> ðŸ’¡ è‹¥å›¾åƒå·²åœ¨ RAM ä¸­ï¼ˆå¦‚å…¨å±€æ•°ç»„ï¼‰ï¼Œå¯ä¼  `NULL` è·³è¿‡æ­¤è®¾ç½®ã€‚

### 3.4 è®¾ç½®é€æ˜Žåº¦

```c
void sgl_ext_img_set_alpha(sgl_obj_t *obj, uint8_t alpha);
```
- **`alpha`**ï¼šé€æ˜Žåº¦ï¼ˆ0 = å®Œå…¨é€æ˜Žï¼Œ255 = å®Œå…¨ä¸é€æ˜Žï¼‰
- é»˜è®¤å€¼ä¸º `SGL_ALPHA_MAX`ï¼ˆå³ 255ï¼‰

---
## 4. ä½¿ç”¨ç¤ºä¾‹

### 4.1 å‡†å¤‡å›¾åƒæ•°æ®

å‡è®¾ä½ æœ‰ä¸¤ä¸ªå›¾åƒèµ„æºï¼š

- `gImage_5`ï¼šæœªåŽ‹ç¼©çš„ RGB565 æ ¼å¼å›¾åƒï¼ˆä½äºŽ Flashï¼‰
- `img_xinxi_yiban_mian__yuanshidaxiao__64x64`ï¼šRLE åŽ‹ç¼©çš„ RGB565 å›¾åƒï¼ˆä½äºŽ Flashï¼‰

### 4.2 å®žçŽ° Flash è¯»å–å‡½æ•°

```c
// ç”¨æˆ·éœ€å®žçŽ°æ­¤å‡½æ•°ä»¥ä»Žå¤–éƒ¨ Flash è¯»å–æ•°æ®
void flash_port_read_data_from_flash(const uint8_t *addr, uint8_t *buf, uint32_t len)
{
    // ç¤ºä¾‹ï¼šè°ƒç”¨ç¡¬ä»¶ Flash è¯»å– API
    Flash_Read((uint32_t)addr, buf, len);
}
```

### 4.3 åˆ›å»ºå¹¶é…ç½® ExtImg æŽ§ä»¶

```c
extern const unsigned char gImage_5[];
extern const unsigned char img_xinxi_yiban_mian__yuanshidaxiao__64x64[];//ä¸€èˆ¬å›¾åƒæ–‡ä»¶ä¼šæ”¾ç½®åœ¨å…¶ä»–æ–‡ä»¶é‡Œé¢ï¼Œæ‰€ä»¥åœ¨è°ƒç”¨çš„æ–‡ä»¶é‡Œé¢è®°å¾—å£°æ˜Žä¸€ä¸‹
// å®šä¹‰æœªåŽ‹ç¼©å›¾åƒ
sgl_pixmap_t test_pixmap = {
    .width  = 64,
    .height = 64,
    .bitmap = gImage_5,
    .format = SGL_PIXMAP_FMT_RGB565,
};

// å®šä¹‰ RLE åŽ‹ç¼©å›¾åƒ
sgl_pixmap_t test_pixmap2 = {
    .width  = 64,
    .height = 64,
    .bitmap = img_xinxi_yiban_mian__yuanshidaxiao__64x64,
    .format = SGL_PIXMAP_FMT_RLE_RGB565,
};

// åˆ›å»ºç¬¬ä¸€ä¸ªå¤–éƒ¨å›¾ç‰‡æŽ§ä»¶
sgl_obj_t *ext_img = sgl_ext_img_create(page);
sgl_obj_set_pos(ext_img, 5 ,10);
sgl_obj_set_size(ext_img, 64, 64); // æ³¨æ„ï¼šåº”è®¾ä¸ºå›¾åƒå®žé™…å°ºå¯¸,ä½†æ˜¯å®žé™…ä¸Šè¿™ä¸ªæŽ¥å£å·²ç»æ²¡ç”¨äº†ï¼Œä¸çŸ¥é“ä»¥åŽä¼šä¸ä¼šæ›´æ–°ï¼Œå°±å…ˆè®¾ç½®ä¸ºå›¾ç‰‡å¤§å°
sgl_ext_img_set_pixmap(ext_img, &test_pixmap);
sgl_ext_img_set_read_ops(ext_img, flash_port_read_data_from_flash);

// åˆ›å»ºç¬¬äºŒä¸ªå¤–éƒ¨å›¾ç‰‡æŽ§ä»¶ï¼ˆRLE åŽ‹ç¼©ï¼‰
sgl_obj_t *ext_img2 = sgl_ext_img_create(page);
sgl_obj_set_pos(ext_img2, 70, 10);
sgl_obj_set_size(ext_img2, 64, 64); // åŒä¸Š
sgl_ext_img_set_pixmap(ext_img2, &test_pixmap2);
sgl_ext_img_set_read_ops(ext_img2, flash_port_read_data_from_flash);
```

![png0](imag/5/1.png)

> ðŸ’¡ éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯åŽ‹ç¼©å›¾ç‰‡ï¼Œä¸å†ä¼šæ”¯æŒå›¾ç‰‡çš„ç¼©æ”¾ï¼ŒåŒæ—¶åŽ‹ç¼©å›¾ç‰‡åœ¨ç”¨WeGuiçš„å·¥å…·å–è†œçš„æ—¶å€™éœ€è¦å‹¾é€‰äº¤æ¢å¤§å°ç«¯å¦åˆ™å›¾ç‰‡ä¼šç”»å¼‚ã€‚

---

## 5. å·¥ä½œåŽŸç†ç®€è¿°

1. å½“ `ExtImg` éœ€è¦ç»˜åˆ¶æ—¶ï¼ŒSGL è°ƒç”¨å…¶ `construct_fn`ï¼ˆå³ `sgl_ext_img_construct_cb`ï¼‰
2. æ ¹æ® `pixmap->format` åˆ¤æ–­æ˜¯å¦ä¸º RLE åŽ‹ç¼©ï¼š
   - **éž RLE**ï¼šæŒ‰è¡Œè¯»å–åƒç´ æ•°æ®ï¼ˆé€šè¿‡ `read_ops` æˆ–ç›´æŽ¥è®¿é—®ï¼‰
   - **RLE**ï¼šä½¿ç”¨å†…éƒ¨ RLE è§£åŽ‹å™¨é€è¡Œè§£ç 
3. å°†è§£ç åŽçš„åƒç´ ä¸Žç›®æ ‡ç¼“å†²åŒºæ··åˆï¼ˆè€ƒè™‘ `alpha` å€¼ï¼‰
4. æœ€ç»ˆå†™å…¥å¸§ç¼“å†²åŒº

---

## 6. æ€»ç»“

- âœ… **RLE åŽ‹ç¼©èŠ‚çœç©ºé—´**ï¼šå¯¹äºŽé¢œè‰²å•ä¸€çš„å›¾æ ‡ï¼ŒRLE å¯å¤§å¹…å‡å° Flash å ç”¨
- âœ… **è¯»å–å‡½æ•°å¥å£®æ€§**ï¼šç¡®ä¿ `flash_port_read_data_from_flash` èƒ½å¤„ç†ä»»æ„åœ°å€å’Œé•¿åº¦
- âœ… **é¿å…é¢‘ç¹åˆ›å»º/é”€æ¯**ï¼š`ExtImg` é€‚åˆé™æ€å›¾åƒï¼›åŠ¨æ€å›¾å»ºè®®å¤ç”¨æŽ§ä»¶å¹¶æ›´æ–° `pixmap`

---
> ðŸ“˜ **ç›¸å…³å¤´æ–‡ä»¶è·¯å¾„**  
> - ext_img APIï¼š`sgl/source/widgets/ext_img/sgl_ext_img.h   
> - æ ¸å¿ƒå¯¹è±¡ï¼š`sgl/source/include/sgl_core.h`
---